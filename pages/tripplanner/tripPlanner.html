<!DOCTYPE html>
<!-- Current Version -->
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trip Calendar + Map Prototype</title>
    <link rel="stylesheet" href="../../styles/tripplanner/mono.css" />

    <script src="../../scripts/general/config.js"></script>

    <!-- Mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- Icons & Flatpickr -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/suncalc/suncalc.js"></script>

    <!-- Scripts Unlikely to Need Refactoring -->
    <script src="../../scripts/tripplanner/helper/datetime.js"></script>
    <script src="../../scripts/tripplanner/helper/externaldata.js"></script>
    <script src="../../scripts/tripplanner/helper/newId.js"></script>
    <script src="../../scripts/tripplanner/helper/logger.js"></script>

    <!-- Scripts -->
    <script src="../../scripts/tripplanner/rendering/timeline.js"></script>
    <script src="../../scripts/tripplanner/rendering/segmentEditor.js"></script>

    <script src="../../scripts/tripplanner/rendering/map.js"></script>
    <script src="../../scripts/tripplanner/runPipeline.js"></script>

    <script src="../../scripts/tripplanner/tripInitiationSequence.js"></script>

    <script src="../../scripts/tripplanner/stopCreateUpdate/createStop.js"></script>
    <script src="../../scripts/tripplanner/stopCreateUpdate/segmentEditing.js"></script>
    <script src="../../scripts/tripplanner/stopCreateUpdate/segLabel.js"></script>

    <script src="../../scripts/tripplanner/ordering/delete.js"></script>
    <script src="../../scripts/tripplanner/ordering/ordering.js"></script>
    <script src="../../scripts/tripplanner/ordering/queueing.js"></script>
    <script src="../../scripts/tripplanner/ordering/getSegmentsInTimeWindow.js"></script>

    <script src="../../scripts/tripplanner/routing/routing.js"></script>

    <!--<script src="scripts/newFunctions.js"></script>-->

    <script src="../../scripts/tripplanner/timing/timingPropagation.js"></script>
    <script src="../../scripts/tripplanner/timing/timingSetters.js"></script>
    <script src="../../scripts/tripplanner/timing/timingSlackOverlap.js"></script>
    <script src="../../scripts/tripplanner/timing/overlapResolution.js"></script>

    <script src="../../scripts/tripplanner/sublists/sublists.js"></script>


    <script src="../../scripts/tripplanner/enrichment/insolation.js"></script>

    <script src="../../scripts/tripplanner/poi/poi.js"></script>

    <script>
        let segments = [];
        let tripMap = null;
        let mapReady = false;
        let pendingSegments = null;

        mapboxgl.accessToken =            MAPBOX_TOKEN2;

        const SEG_KEY = 'tripSegments';

        let PIPELINELEVEL = 'conflict';
        const PLANNING_DIRECTION = 'forward'; // 'backward' or 'forward'

        function loadSegments() {
            return JSON.parse(localStorage.getItem(SEG_KEY)) || [];
        }

        function saveSegments(next) {
            localStorage.setItem(SEG_KEY, JSON.stringify(next));
            return next;
        }

        // Keep a single in-memory copy in sync when needed
        function syncGlobal() {
            segments = loadSegments();
            return segments;
        }
    </script>

    <script>
        function resetTrip() {
            const confirmWipe = confirm('Clear all trip data and start fresh?');
            if (!confirmWipe) return;

            // Remove tripSegments from localStorage
            localStorage.removeItem(SEG_KEY);

            // Reset globals
            segments = [];
            PIPELINELEVEL = 'conflict';
            pendingSegments = null;

            // Now force UI to reset
            renderTimeline([]);
            renderMap([]);
            updateStopDropdown([]);

            console.log('Trip has been reset.');
        }
    </script>

    <script defer>
        window.addEventListener('DOMContentLoaded', () => {
            // --- TOOLBAR HOOKS ---
            document.getElementById('mode-timeline').onclick = () =>
                renderTimeline(syncGlobal());

            document.getElementById('init-trip').onclick = () => {
                logAction('initTripClicked', {});
                initTrip();
            };

            document.getElementById('add-stop').onclick = () => {
                logAction('addStopClicked', {});
                let segs = loadSegments();
                queueStop(segs);
                saveSegments(segs);
                renderTimeline(syncGlobal());
                renderMap(syncGlobal());
            };

            document.getElementById('clear-auto').onclick = () => {
                logAction('clearAutoDrivesClicked', {});
                let segs = loadSegments();
                segs = removeSlackAndOverlap(segs);

                segs = clearAutoDrives(segs);
                PIPELINELEVEL = '';
                saveSegments(segs);
                renderTimeline(syncGlobal());
                renderMap(syncGlobal());
            };

            document.getElementById('validate-btn').onclick = async() => {
                logAction('validateAndRepairRoutesClicked', {});
                let segs = loadSegments();
                segs = removeSlackAndOverlap(segs);
                segs = await validateAndRepair(segs);
                PIPELINELEVEL = 'routing';
                saveSegments(segs);
                renderTimeline(syncGlobal());
                renderMap(syncGlobal());
            };

            document.getElementById('clear-unlocked-times').onclick = () => {
                logAction('clearUnlockedTimesClicked', {});
                let segs = loadSegments();
                segs = removeSlackAndOverlap(segs);

                segs = clearTimesAndDurations(segs);
                if (PIPELINELEVEL === '') {
                    PIPELINELEVEL = '';
                } else {
                    PIPELINELEVEL = 'routing';
                }
                saveSegments(segs);
                renderTimeline(syncGlobal());
                renderMap(syncGlobal());
            };

            document.getElementById('fill-times').onclick = async() => {
                logAction('fillTimesClicked', {});
                let segs = loadSegments();
                segs = removeSlackAndOverlap(segs);
                segs = await validateAndRepair(segs); // test
                //segs = annotateEmitters(segs);
                segs = determineEmitterDirections(segs, {
                    priority: PLANNING_DIRECTION
                });
                segs = propagateTimes(segs);
                segs = computeSlackAndOverlap(segs);
                PIPELINELEVEL = 'timing';
                saveSegments(segs);
                renderTimeline(syncGlobal());
                renderMap(syncGlobal());
            };

            document.getElementById('validate-constraints').onclick = () => {
                let segs = loadSegments();
                validateTrip(segs);
                console.log('VALIDATION RESULTS:', validateTrip(segs));
            };

            // === Export ===
            document.getElementById('export-data').onclick = () => {
                const data = loadSegments();
                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tripSegments.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            // === Import ===
            document.getElementById('import-data').onclick = () => {
                document.getElementById('import-file').click();
            };

            document
                .getElementById('import-file')
                .addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const parsed = JSON.parse(reader.result);
                            if (!Array.isArray(parsed))
                                throw new Error('File does not contain an array');
                            saveSegments(parsed);
                            alert('Trip data imported successfully.');
                            renderTimeline(syncGlobal());
                            renderMap(syncGlobal());
                        } catch (err) {
                            alert('Import failed: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                });

            document.getElementById('reset-trip').onclick = () => {
                resetTrip();
            };

            document
                .getElementById('poi-source')
                .addEventListener('change', (e) => {
                    const select = document.getElementById('poi-stop-select');
                    select.style.display =
                        e.target.value === 'stop' ? 'inline-block' : 'none';
                });

            document.getElementById('poi-refresh').addEventListener('click', () => {
                runPOISearch();
            });

            initMap();

            const segs = syncGlobal();
            renderTimeline(segs);
            updateStopDropdown(segs);
            renderMap(segs);
        });
    </script>
</head>

<body>
    <div id="toolbar" class="toolbar">
        <!-- === SELECT === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Select ▼</button>
            <div class="dropdown-content">
                <button id="mode-timeline">Show Timeline</button>
                <button id="init-trip">Start Trip</button>
                <button id="add-stop">Add Segment</button>
            </div>
        </div>

        <!-- === DEFINE (duration + constraints) === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Define ▼</button>
            <div class="dropdown-content">
                <button id="validate-constraints">Validate Constraints</button>
                <!-- In future: Add “Default Duration”, “Opening Hours”, “Visit Constraints” -->
            </div>
        </div>

        <!-- === ORDER === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Order ▼</button>
            <div class="dropdown-content">
                <!-- You will add reorder tab or view modes here later -->
                <button onclick="alert('Use drag & drop in the timeline.')">
            Reorder (Drag)
          </button>
            </div>
        </div>

        <!-- === STRUCTURE === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Structure ▼</button>
            <div class="dropdown-content">
                <!-- Future: group/ungroup actions -->
                <button onclick="alert('Grouping UI coming soon.')">
            Group / Ungroup
          </button>
            </div>
        </div>

        <!-- === ROUTING === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Routing ▼</button>
            <div class="dropdown-content">
                <button id="clear-auto">Clear Auto Drives</button>
                <button id="validate-btn">Validate & Repair Routing</button>
                <!-- Future: Insert drives, regenerate, edit waypoints -->
            </div>
        </div>

        <!-- === TIMING === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Timing ▼</button>
            <div class="dropdown-content">
                <button id="clear-unlocked-times">Clear Unlocked Times</button>
                <button id="fill-times">Fill Times</button>
            </div>
        </div>

        <!-- === CONFLICT RESOLUTION === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Conflicts ▼</button>
            <div class="dropdown-content">
                <!-- Slack & overlap tools -->
                <button onclick="alert('Slack/Overlap is auto-handled during Fill Times')">
            Review Conflicts
          </button>
            </div>
        </div>

        <!-- === IMPORT / EXPORT === -->
        <div class="toolbar-group dropdown">
            <button class="dropbtn">Data ▼</button>
            <div class="dropdown-content">
                <button id="reset-trip">Reset Trip</button>
                <button id="export-data">Export Data</button>
                <button id="import-data">Import Data</button>
                <input type="file" id="import-file" accept="application/json" style="display: none" />
            </div>
        </div>

        <div id="auth">
            <button id="login">Login with GitHub</button>
            <button id="logout" style="display: none">Logout</button>
            <span id="auth-status">Not logged in</span>
        </div>
    </div>

    <!-- MAP PANE -->
    <div id="map"></div>

    <div id="bottom-flex">
        <!-- TIMELINE (bottom-left) -->
        <div id="calendar" class="timeline"></div>

        <!-- POI PANE (bottom-right) -->
        <div id="poi-pane">
            <div style="margin-bottom: 8px">
                <select id="poi-source">
            <option value="center">Closest to Map Center</option>
            <option value="stop">Closest to Stop</option>
            <option value="route">Closest to Route</option>
          </select>

                <select id="poi-stop-select" style="display: none"></select>

                <button id="poi-refresh">Refresh</button>
            </div>

            <h3>AZA Zoos</h3>
            <table id="aza-table">
                <thead>
                    <tr>
                        <th>Add to Trip</th>
                        <th>Name</th>
                        <th>City</th>
                        <th>State</th>
                        <th>Drive Time (min)</th>
                        <th>Distance (mi)</th>
                        <th>Visited</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        var currentUser = null;
        var USER_ID = null;

        // --- Supabase setup ---
        const supabase = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
        );

        const loginBtn = document.getElementById('login');
        const logoutBtn = document.getElementById('logout');
        const statusEl = document.getElementById('auth-status');

        loginBtn.addEventListener('click', async() => {
            const {
                error
            } = await supabase.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    redirectTo: window.location.href,
                    auth_params: {
                        prompt: 'select_account'
                    }
                }
            });
            if (error) console.error('Login error:', error);
        });

        logoutBtn.addEventListener('click', async function() {
            await supabase.auth.signOut();
        });

        supabase.auth.onAuthStateChange(function(event, session) {
            if (
                (event === 'INITIAL_SESSION' || event === 'SIGNED_IN') &&
                window.location.hash.includes('access_token')
            ) {
                const baseUrl = window.location.href.split('#')[0];
                window.history.replaceState({}, document.title, baseUrl);
            }

            if (session && session.user) {
                currentUser = session.user;
                USER_ID = currentUser.id;
                console.log('Logged in as:', USER_ID);
                if (typeof loadVisited === 'function') {
                    //loadVisited();  /temp
                }
            } else {
                currentUser = null;
                USER_ID = null;
                if (typeof visitedAZAs !== 'undefined') {
                    visitedAZAs = new Set();
                }
            }

            const loggedIn = currentUser !== null;
            loginBtn.style.display = loggedIn ? 'none' : 'inline-block';
            logoutBtn.style.display = loggedIn ? 'inline-block' : 'none';
            statusEl.textContent = loggedIn ?
                'Logged in as ' + currentUser.user_metadata.user_name :
                'Not logged in';
        });

        // --- Search handler ---
        let lastSearchCoords = null;
    </script>
</body>

</html>