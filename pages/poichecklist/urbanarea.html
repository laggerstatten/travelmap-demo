<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Identify Location + Local UAs + Routes</title>

    <script src="../../scripts/general/config.js"></script>
    <script src="../../scripts/poichecklist/drivetime_local.js"></script>
    <script src="../../scripts/poichecklist/drivetime_major.js"></script>
    <script src="../../scripts/poichecklist/drivetime.js"></script>
    <script src="../../scripts/poichecklist/buildUAPopup.js"></script>

    <!-- Mapbox -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

    <link
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Open Sans", sans-serif;
        overflow: hidden;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        z-index: 1;
      }

      #search-box {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        width: 320px;
      }

      #auth {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 11;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      }

      #auth button {
        margin: 0 4px;
        padding: 4px 8px;
      }
      /* Drawer styling */

      #result-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.97);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.25);
        max-height: 50%;
        transform: translateY(60%);
        transition: transform 0.4s ease-in-out;
        overflow: auto;
        z-index: 20;
        padding: 10px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }

      #result-panel.open {
        transform: translateY(0);
      }

      #result-toggle {
        position: absolute;
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        border-radius: 10px 10px 0 0;
        padding: 6px 16px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        user-select: none;
        z-index: 25;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.25);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        border-bottom: 1px solid #ccc;
        text-align: left;
        padding: 6px;
      }

      th {
        background-color: #f2f2f2;
      }

      tr:hover {
        background-color: #f0f8ff;
        cursor: pointer;
      }

      .visited {
        background-color: #dff0d8 !important;
      }
    </style>
  </head>

  <body>
    <div id="search-box"></div>

    <div id="auth">
      <button id="login">Login with GitHub</button>
      <button id="logout" style="display: none">Logout</button>
      <span id="auth-status">Not logged in</span>
    </div>

    <div id="map"></div>

    <!-- Drawer -->
    <div id="result-panel">
      <div id="result-toggle">▲ Show Results</div>
      <h3>Local Urban Areas</h3>
      <table id="local-ua-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Population</th>
            <th>Drive Time (min)</th>
            <th>Distance (mi)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3>Major Urban Areas (within 500 mi)</h3>
      <table id="major-ua-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Population</th>
            <th>Drive Time (min)</th>
            <th>Distance (mi)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      // --- REQUIRED: define identify URL ---
      //SUPABASE_IDENTIFY_URL = SUPABASE_IDENTIFY_URL ?? window.SUPABASE_IDENTIFY_URL;

      // --- State ---
      let currentUser = null;
      let USER_ID = null;
      //let visitedAZAs = new Set();
      let marker = null;
      let lastSearchCoords = null;
      let popup = null;
      const routeLayerId = "route-line";

      // --- Supabase setup ---
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // Fix hash fragment from GitHub OAuth
      supabase.auth.onAuthStateChange((event, session) => {
        if (
          (event === "INITIAL_SESSION" || event === "SIGNED_IN") &&
          window.location.hash.includes("access_token")
        ) {
          window.history.replaceState(
            {},
            document.title,
            window.location.href.split("#")[0]
          );
        }
      });

      const loginBtn = document.getElementById("login");
      const logoutBtn = document.getElementById("logout");
      const statusEl = document.getElementById("auth-status");

      loginBtn.onclick = async () => {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "github",
          options: {
            redirectTo: window.location.href,
            auth_params: { prompt: "select_account" },
          },
        });
        if (error) console.error(error);
      };

      logoutBtn.onclick = async () => {
        await supabase.auth.signOut();
      };

      supabase.auth.onAuthStateChange((_event, session) => {
        if (session?.user) {
          currentUser = session.user;
          USER_ID = currentUser.id;
          console.log("Logged in as:", USER_ID);
          //loadVisited();
        } else {
          currentUser = null;
          USER_ID = null;
          //visitedAZAs.clear();
        }

        const loggedIn = !!currentUser;
        loginBtn.style.display = loggedIn ? "none" : "inline-block";
        logoutBtn.style.display = loggedIn ? "inline-block" : "none";
        statusEl.textContent = loggedIn
          ? `Logged in as ${currentUser.user_metadata.user_name}`
          : "Not logged in";
      });

      // --- Map setup ---
      mapboxgl.accessToken = MAPBOX_TOKEN;
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/ericschall/clvvt5o32098a01nucx668i03",
        center: [-103.59, 40.67],
        zoom: 3,
      });

      // --- Geocoder ---
      const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false, // we add our own marker later
        types: "country,region,place,postcode,locality,neighborhood",
        placeholder: "Search location...",
        limit: 5,
      });

      geocoder.addTo("#search-box");

      let originLng = null;
      let originLat = null;

      const resultPanel = document.getElementById("result-panel");
      const resultToggle = document.getElementById("result-toggle");

      resultToggle.onclick = () => {
        const isOpen = resultPanel.classList.contains("open");
        if (isOpen) {
          resultPanel.classList.remove("open");
          resultToggle.textContent = "▲ Show Results";
        } else {
          resultPanel.classList.add("open");
          resultToggle.textContent = "▼ Hide Results";
        }
      };

      function openDrawer() {
        const isOpen = resultPanel.classList.contains("open");
        if (!isOpen) {
          resultPanel.classList.add("open");
          resultToggle.textContent = "▼ Hide Results";
        }
      }

      function closeDrawer() {
        const isOpen = resultPanel.classList.contains("open");
        if (isOpen) {
          resultPanel.classList.remove("open");
          resultToggle.textContent = "▲ Show Results";
        }
      }

      // --- Search handler ---
      geocoder.on("result", async (e) => {
        const f = e.result;
        if (!f?.geometry) return;

        const [lng, lat] = f.geometry.coordinates;
        const rounded = [Number(lng.toFixed(4)), Number(lat.toFixed(4))];

        if (
          lastSearchCoords &&
          rounded[0] === lastSearchCoords[0] &&
          rounded[1] === lastSearchCoords[1]
        ) {
          console.log("Ignoring duplicate geocoder result");
          return;
        }

        lastSearchCoords = rounded;

        console.log(`Selected: ${f.properties?.name} → ${lat}, ${lng}`);
        originLng = lng;
        originLat = lat;

        // Update marker
        marker?.remove();
        marker = new mapboxgl.Marker({ color: "#FF5E00" })
          .setLngLat([lng, lat])
          .addTo(map);

        map.flyTo({ center: [lng, lat], zoom: 8 });

        const info = await identifyLocation(lng, lat);
        console.log("Location info:", info);

        // Clear tables at start of each search
        updateLocalUATable([]);
        updateMajorUATable([]);

        buildUAPopup(info, lng, lat);

        fetchLocalUA(info, lat, lng);
        fetchMajorUA(lat, lng);

        openDrawer();
      });

      async function identifyLocation(lng, lat) {
        // --- IDENTIFY LOCATION ---

        try {
          const res = await fetch(SUPABASE_IDENTIFY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lng, lat }),
          });
          return await res.json();
        } catch (err) {
          console.error("Identify failed:", err);
          return null;
        }
      }
    </script>
  </body>
</html>
